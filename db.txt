create table "public"."events" (
    "id" bigint generated always as identity not null,
    "title" text not null,
	  "location" text not null,
    "date" date not null,
	  "time" time not null,
    "created_at" timestamp with time zone default now(),
    "user_id" uuid not null references auth.users(id)
    );



  create table "public"."notes" (
    "id" bigint generated always as identity not null,
    "title" text not null,
    "note" text not null,
    "date" date not null,
    "created_at" timestamp with time zone default now(),
    "user_id" uuid not null references auth.users(id)
    );



  create table "public"."planners" (
    "id" bigint generated always as identity not null,
    "title" text not null,
    "b_color" text not null default 'white'::text,
    "a_color" text not null default 'black'::text,
    "font" text not null default 'sans-serif'::text
    );



  create table "public"."tasks" (
    "id" bigint generated always as identity not null,
    "title" text not null,
    "task" text not null,
    "date" date not null,
    "done" bool not null default false,
    "created_at" timestamp with time zone default now(),
    "user_id" uuid not null references auth.users(id)
    );




    -- Create 'profiles' table
create table if not exists profiles (
    id uuid references auth.users(id) on delete cascade,
    name text not null,
    bio text,
    avatar text,
    created_at timestamp with time zone default now() not null,
    updated_at timestamp with time zone default now() not null,
    primary key (id)
);

-- Trigger function to update 'updated_at' on row change
create or replace function update_updated_at_column()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

-- Attach trigger to 'profiles' table
drop trigger if exists set_updated_at on profiles;
create trigger set_updated_at
before update on profiles
for each row
execute function update_updated_at_column();



-- =============================================
-- CREATE TABLES
-- =============================================

-- Lists table
create table if not exists lists (
    id bigint generated always as identity primary key,
    user_id uuid not null references auth.users(id) on delete cascade,
    name text not null,
    created_at timestamp with time zone default now()
);

-- Items table
create table if not exists items (
    id bigint generated always as identity primary key,
    list_id bigint not null references lists(id) on delete cascade,
    title text not null,
    done boolean default false,
    created_at timestamp with time zone default now()
);

-- =============================================
-- ENABLE ROW LEVEL SECURITY
-- =============================================

alter table lists enable row level security;
alter table items enable row level security;

-- =============================================
-- LISTS POLICIES
-- =============================================

-- SELECT
create policy "Users can read their own lists"
on lists
for select
to authenticated
using (user_id = auth.uid());

-- INSERT
create policy "Users can insert their own lists"
on lists
for insert
to authenticated
with check (user_id = auth.uid());

-- UPDATE
create policy "Users can update their own lists"
on lists
for update
to authenticated
using (user_id = auth.uid());

-- DELETE
create policy "Users can delete their own lists"
on lists
for delete
to authenticated
using (user_id = auth.uid());

-- =============================================
-- ITEMS POLICIES
-- =============================================

-- SELECT
create policy "Users can read items of their lists"
on items
for select
to authenticated
using (
    exists (
        select 1 from lists
        where lists.id = items.list_id
        and lists.user_id = auth.uid()
    )
);

-- INSERT
create policy "Users can insert items into their lists"
on items
for insert
to authenticated
with check (
    exists (
        select 1 from lists
        where lists.id = items.list_id
        and lists.user_id = auth.uid()
    )
);

-- UPDATE
create policy "Users can update items of their lists"
on items
for update
to authenticated
using (
    exists (
        select 1 from lists
        where lists.id = items.list_id
        and lists.user_id = auth.uid()
    )
);

-- DELETE
create policy "Users can delete items of their lists"
on items
for delete
to authenticated
using (
    exists (
        select 1 from lists
        where lists.id = items.list_id
        and lists.user_id = auth.uid()
    )
);



-- Loo tabel photos
create table public.photos (
  id uuid default gen_random_uuid() primary key, -- unikaalne ID
  user_id uuid not null references auth.users(id) on delete cascade, -- seotud Supabase auth kasutajaga
  url text not null, -- pildi URL
  title text, -- pildi pealkiri
  uploaded_at timestamp with time zone default now() -- üleslaadimise aeg
);

-- Anna õigused, et autentitud kasutaja saaks lisada, kustutada ja lugeda oma fotosid
grant select, insert, update, delete on public.photos to authenticated;
